
1. cd src/main/resources/metadata

2. pull idp metadata:

wget --no-check-certificate https://IL1SCOLIDP102/idp/shibboleth -O idp-IL1SCOLIDP102-metadata.xml

wget --no-check-certificate https://idp.symas.com/idp/shibboleth -O idp-symas-com-metadata.xml

3. push sp metadata:

scp /home/smckinn/Development/fortress-saml-demo/src/main/resources/metadata/fortress-saml-demo-sp.xml root@IL1SCOLIDP102:/opt/shibboleth-idp/metadata

scp /home/smckinn/Development/fortress-saml-demo/src/main/resources/metadata/fortress-saml-demo-sp.xml root@idp.symas.com:/opt/shibboleth-idp/metadata  

4. update IdP Files:

a. relying-party.xml

add:

   <bean parent="RelyingPartyByName" c:relyingPartyIds="fortress-saml-demo">
          <property name="profileConfigurations">
          <list>
          <!-- Your refs or beans here. -->
              <bean parent="SAML2.SSO" p:encryptAssertions="false" />
          </list>
          </property>
    </bean>


b. metadata-providers.xml

add:

  <MetadataProvider id="fortress-saml-demo"  xsi:type="FilesystemMetadataProvider" metadataFile="/opt/shibboleth-idp/metadata/fortress-saml-demo-sp.xml"/>

c. attribute-filter.xml

add:

    <afp:AttributeFilterPolicy id="fortress-demo">
        <afp:PolicyRequirementRule xsi:type="basic:AttributeRequesterString" value="fortress-saml-demo" />

        <afp:AttributeRule attributeID="uid">
            <afp:PermitValueRule xsi:type="basic:ANY" />
        </afp:AttributeRule>

        <afp:AttributeRule attributeID="mail">
            <afp:PermitValueRule xsi:type="basic:ANY" />
        </afp:AttributeRule>
    </afp:AttributeFilterPolicy>

d. to add new attributes in request, i.e. role assignments (work in progress)

edit:
attribute-resolver-ldap.xml, attribute-resolver.xml

5. restart idp

6. add metadata to sp side
a. edit securityContext.xml
b. add
                <bean class="org.opensaml.saml2.metadata.provider.HTTPMetadataProvider">
                    <constructor-arg>
                        <value type="java.lang.String">https://il1scolidp102/idp/shibboleth</value>
                    </constructor-arg>
                    <constructor-arg>
                        <value type="int">5000</value>
                    </constructor-arg>
                    <property name="parserPool" ref="parserPool"/>
                </bean>

only needed for http metadata provider:
7. add IdP Cert to SP trust store:

a. pull it down:

 ls -l /etc/ssl/certs/IL1SCOLIDP102.crt

scp root@IL1SCOLIDP102:/etc/ssl/certs/IL1SCOLIDP102.crt /home/smckinn/Development/fortress-saml-demo/src/main/resources 

b. import:

keytool -import -alias symas-idp -file /home/smckinn/Development/fortress-saml-demo/src/main/resources/IL1SCOLIDP102.crt -keystore cacerts -storepass changeit
 
keytool -import -alias symas-idp -file /home/smckinn/Development/fortress-saml-demo/src/main/resources/IL1SCOLIDP102.crt -keystore /home/smckinn/JavaTools/apache-tomcat-8.0.21/conf/mykeystore -storepass changeit

8. redeploy saml demo app


principal
AAdzZWNyZXQxlL3coTmKXEDXK8CjrdGVFHATLEQcVOYdnHLF1BLRtA+aKLVNwO/Skrmaok2f0IwVVxcwu075WFIo+AyhezhjlU6Q7+0qdRe85OWVjqUc1ZNJtiaGhlAVOOb/zWZ3o6AAtWruRg==
